<div class="space-y-6">
    <!-- Hero: Key Types Overview -->
    <div class="bg-gradient-to-r from-amber-500 to-orange-600 text-white rounded-lg p-6">
        <h3 class="text-2xl font-bold mb-2">{{ viz_data.key_types.title }}</h3>
        <p class="text-amber-100 mb-4">Keys establish identity and relationships in your database</p>

        <div class="grid md:grid-cols-4 gap-3 mt-4">
            {% for key in viz_data.key_types['keys'] %}
            <div class="bg-white/20 rounded-lg p-3">
                <div class="flex items-center mb-2">
                    <span class="w-8 h-8 rounded-full bg-{{ key.color }}-400 text-{{ key.color }}-900 flex items-center justify-center text-xs font-bold mr-2">
                        {{ key.symbol }}
                    </span>
                    <span class="font-bold text-sm">{{ key.name }}</span>
                </div>
                <p class="text-xs text-amber-100">{{ key.description }}</p>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Key Types Detail -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-amber-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-amber-800">Key Types Explained</h4>
        </div>
        <div class="divide-y">
            {% for key in viz_data.key_types['keys'] %}
            <div class="p-4">
                <div class="flex items-start">
                    <span class="w-10 h-10 rounded-lg bg-{{ key.color }}-100 text-{{ key.color }}-700 flex items-center justify-center text-sm font-bold mr-4 flex-shrink-0">
                        {{ key.symbol }}
                    </span>
                    <div class="flex-1">
                        <h5 class="font-semibold text-lg">{{ key.name }}</h5>
                        <p class="text-gray-600 text-sm mb-3">{{ key.description }}</p>

                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- Rules -->
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Rules:</div>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    {% for rule in key.rules %}
                                    <li class="flex items-start">
                                        <span class="text-{{ key.color }}-500 mr-2">-</span>
                                        {{ rule }}
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>

                            <!-- Syntax -->
                            <div>
                                <div class="text-sm font-medium text-gray-700 mb-2">Syntax:</div>
                                <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">{{ key.syntax }}</pre>
                                <div class="mt-2 text-xs text-gray-500">
                                    Examples: {{ key.examples | join(', ') }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Relationship Cardinality -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-indigo-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-indigo-800">{{ viz_data.relationships.title }}</h4>
        </div>
        <div class="p-4 grid md:grid-cols-2 gap-6">
            {% for rel in viz_data.relationships.types %}
            <div class="border rounded-lg overflow-hidden">
                <div class="bg-indigo-100 px-4 py-2 flex items-center justify-between">
                    <span class="font-bold text-indigo-800">{{ rel.name }}</span>
                    <code class="text-xs font-mono bg-white px-2 py-1 rounded">{{ rel.notation }}</code>
                </div>
                <div class="p-4">
                    <p class="text-sm text-gray-600 mb-3">{{ rel.description }}</p>

                    <!-- Real Examples -->
                    <div class="flex flex-wrap gap-2 mb-3">
                        {% for ex in rel.real_examples %}
                        <span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded text-xs">{{ ex }}</span>
                        {% endfor %}
                    </div>

                    <!-- Implementation -->
                    <div class="bg-gray-50 rounded p-3 mb-3">
                        <div class="text-xs font-medium text-gray-700 mb-1">Implementation:</div>
                        <div class="text-sm text-gray-600">{{ rel.implementation }}</div>
                    </div>

                    <!-- SQL Example -->
                    <pre class="bg-gray-100 rounded p-3 text-xs overflow-x-auto">{{ rel.sql_example }}</pre>

                    {% if rel.key_insight %}
                    <div class="mt-3 bg-green-50 border border-green-200 rounded p-2 text-sm text-green-700">
                        {{ rel.key_insight }}
                    </div>
                    {% endif %}

                    {% if rel.warning %}
                    <div class="mt-3 bg-yellow-50 border border-yellow-200 rounded p-2 text-sm text-yellow-700">
                        {{ rel.warning }}
                    </div>
                    {% endif %}

                    {% if rel.junction_table_tips %}
                    <div class="mt-3">
                        <div class="text-xs font-medium text-gray-700 mb-1">Junction Table Tips:</div>
                        <ul class="text-xs text-gray-600 space-y-1">
                            {% for tip in rel.junction_table_tips %}
                            <li>- {{ tip }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Schema Diagram -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-purple-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-purple-800">{{ viz_data.our_schema.title }}</h4>
        </div>
        <div class="p-4">
            <!-- Tables Grid -->
            <div class="grid md:grid-cols-3 gap-4 mb-6">
                {% for table in viz_data.our_schema.tables %}
                <div class="border rounded-lg overflow-hidden hover:shadow-md transition-shadow">
                    <div class="bg-purple-100 px-3 py-2 font-bold text-purple-800">{{ table.name }}</div>
                    <table class="w-full text-sm">
                        {% for col in table.columns %}
                        <tr class="border-t hover:bg-gray-50">
                            <td class="px-3 py-1.5 font-mono text-xs">
                                {% if col.key == 'PK' %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded bg-yellow-100 text-yellow-700 text-xs font-bold mr-1">PK</span>
                                {% elif col.key == 'FK' %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded bg-blue-100 text-blue-700 text-xs font-bold mr-1">FK</span>
                                {% elif col.key == 'UQ' %}
                                <span class="w-5 h-5 inline-flex items-center justify-center rounded bg-green-100 text-green-700 text-xs font-bold mr-1">UQ</span>
                                {% else %}
                                <span class="w-5 h-5 inline-block mr-1"></span>
                                {% endif %}
                                {{ col.name }}
                            </td>
                            <td class="px-2 py-1.5 text-gray-500 text-xs">{{ col.type }}</td>
                            <td class="px-2 py-1.5 text-xs">
                                {% if col.nullable %}<span class="text-gray-400">NULL</span>{% endif %}
                                {% if col.references %}<span class="text-blue-600">→ {{ col.references }}</span>{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </table>
                </div>
                {% endfor %}
            </div>

            <!-- Relationships -->
            <div class="bg-gray-50 rounded-lg p-4">
                <h5 class="font-semibold text-gray-700 mb-3">Relationships</h5>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-2">
                    {% for rel in viz_data.our_schema.relationships %}
                    <div class="bg-white rounded border p-2 text-sm flex items-center">
                        <code class="text-blue-600 text-xs">{{ rel.from }}</code>
                        <span class="mx-2 text-gray-400">→</span>
                        <code class="text-purple-600 text-xs">{{ rel.to }}</code>
                        <span class="ml-2 text-xs text-gray-500">({{ rel.label }})</span>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>

    <!-- Constraint Demo -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-red-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-red-800">{{ viz_data.constraint_demo.title }}</h4>
        </div>
        <div class="divide-y">
            {% for scenario in viz_data.constraint_demo.scenarios %}
            <div class="p-4">
                <h5 class="font-semibold text-red-700 mb-2">{{ scenario.name }}</h5>
                <p class="text-gray-600 text-sm mb-3">{{ scenario.problem }}</p>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-red-50 rounded p-3">
                        <div class="text-xs text-red-500 font-medium mb-1">Bad:</div>
                        <pre class="text-xs text-red-700 overflow-x-auto">{{ scenario.example_bad }}</pre>
                        <div class="text-xs text-red-600 mt-2">{{ scenario.result }}</div>
                    </div>
                    <div class="bg-green-50 rounded p-3">
                        <div class="text-xs text-green-500 font-medium mb-1">Fix:</div>
                        <div class="text-sm text-green-700">{{ scenario.fix }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Cascade Actions -->
        <div class="border-t bg-orange-50 p-4">
            <h5 class="font-semibold text-orange-800 mb-3">{{ viz_data.constraint_demo.cascade_actions.title }}</h5>
            <div class="grid md:grid-cols-2 gap-3">
                {% for action in viz_data.constraint_demo.cascade_actions.options %}
                <div class="bg-white rounded border p-3">
                    <code class="text-sm font-bold text-orange-700">{{ action.action }}</code>
                    <p class="text-sm text-gray-600 mt-1">{{ action.effect }}</p>
                    <div class="text-xs text-gray-500 mt-2">
                        <span class="font-medium">Example:</span> {{ action.example }}
                    </div>
                    <div class="text-xs text-orange-600 mt-1">
                        <span class="font-medium">Use when:</span> {{ action.use_when }}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Surrogate vs Natural Keys -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-teal-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-teal-800">{{ viz_data.surrogate_vs_natural.title }}</h4>
        </div>
        <div class="p-4">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Surrogate Key -->
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-blue-100 px-4 py-2">
                        <span class="font-bold text-blue-800">{{ viz_data.surrogate_vs_natural.surrogate.name }}</span>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-gray-600 mb-3">{{ viz_data.surrogate_vs_natural.surrogate.definition }}</p>

                        <div class="flex flex-wrap gap-2 mb-3">
                            {% for ex in viz_data.surrogate_vs_natural.surrogate.examples %}
                            <code class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs">{{ ex }}</code>
                            {% endfor %}
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="bg-green-50 rounded p-2">
                                <div class="text-xs font-medium text-green-700 mb-1">Pros</div>
                                <ul class="text-xs text-green-600 space-y-1">
                                    {% for pro in viz_data.surrogate_vs_natural.surrogate.pros %}
                                    <li>+ {{ pro }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="bg-red-50 rounded p-2">
                                <div class="text-xs font-medium text-red-700 mb-1">Cons</div>
                                <ul class="text-xs text-red-600 space-y-1">
                                    {% for con in viz_data.surrogate_vs_natural.surrogate.cons %}
                                    <li>- {{ con }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">{{ viz_data.surrogate_vs_natural.surrogate.sql }}</pre>
                    </div>
                </div>

                <!-- Natural Key -->
                <div class="border rounded-lg overflow-hidden">
                    <div class="bg-purple-100 px-4 py-2">
                        <span class="font-bold text-purple-800">{{ viz_data.surrogate_vs_natural.natural.name }}</span>
                    </div>
                    <div class="p-4">
                        <p class="text-sm text-gray-600 mb-3">{{ viz_data.surrogate_vs_natural.natural.definition }}</p>

                        <div class="flex flex-wrap gap-2 mb-3">
                            {% for ex in viz_data.surrogate_vs_natural.natural.examples %}
                            <code class="bg-purple-50 text-purple-700 px-2 py-1 rounded text-xs">{{ ex }}</code>
                            {% endfor %}
                        </div>

                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div class="bg-green-50 rounded p-2">
                                <div class="text-xs font-medium text-green-700 mb-1">Pros</div>
                                <ul class="text-xs text-green-600 space-y-1">
                                    {% for pro in viz_data.surrogate_vs_natural.natural.pros %}
                                    <li>+ {{ pro }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                            <div class="bg-red-50 rounded p-2">
                                <div class="text-xs font-medium text-red-700 mb-1">Cons</div>
                                <ul class="text-xs text-red-600 space-y-1">
                                    {% for con in viz_data.surrogate_vs_natural.natural.cons %}
                                    <li>- {{ con }}</li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>

                        <pre class="bg-gray-100 rounded p-2 text-xs overflow-x-auto">{{ viz_data.surrogate_vs_natural.natural.sql }}</pre>
                    </div>
                </div>
            </div>

            <!-- Recommendation -->
            <div class="mt-4 bg-teal-50 rounded-lg p-4">
                <h5 class="font-semibold text-teal-800 mb-3">When to Use Which?</h5>
                <div class="grid md:grid-cols-2 gap-4 mb-3">
                    <div>
                        <div class="text-sm font-medium text-blue-700 mb-2">Use Surrogate Keys:</div>
                        <ul class="text-sm text-gray-600 space-y-1">
                            {% for use in viz_data.surrogate_vs_natural.recommendation.use_surrogate %}
                            <li>- {{ use }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-purple-700 mb-2">Use Natural Keys:</div>
                        <ul class="text-sm text-gray-600 space-y-1">
                            {% for use in viz_data.surrogate_vs_natural.recommendation.use_natural %}
                            <li>- {{ use }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="bg-white rounded border-2 border-teal-300 p-3 text-sm text-teal-800">
                    <span class="font-bold">Best Practice:</span> {{ viz_data.surrogate_vs_natural.recommendation.hybrid }}
                </div>
            </div>
        </div>
    </div>

    <!-- Common Mistakes -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-red-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-red-800">Common Mistakes</h4>
        </div>
        <div class="divide-y">
            {% for mistake in viz_data.common_mistakes %}
            <div class="p-4">
                <h5 class="font-medium text-red-700 mb-2">{{ mistake.mistake }}</h5>
                <div class="grid md:grid-cols-3 gap-3">
                    <div class="bg-red-50 rounded p-2">
                        <div class="text-xs text-red-500 font-medium mb-1">Problem:</div>
                        <div class="text-sm text-red-700">{{ mistake.problem }}</div>
                    </div>
                    <div class="bg-gray-50 rounded p-2">
                        <div class="text-xs text-gray-500 font-medium mb-1">Example:</div>
                        <code class="text-xs text-gray-700">{{ mistake.example }}</code>
                    </div>
                    <div class="bg-green-50 rounded p-2">
                        <div class="text-xs text-green-500 font-medium mb-1">Fix:</div>
                        <div class="text-sm text-green-700">{{ mistake.fix }}</div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Best Practices -->
    <div class="bg-white border rounded-lg overflow-hidden">
        <div class="bg-green-50 px-4 py-3 border-b">
            <h4 class="font-semibold text-green-800">Best Practices</h4>
        </div>
        <div class="p-4 grid md:grid-cols-2 gap-4">
            {% for practice in viz_data.best_practices %}
            <div class="border rounded-lg p-4">
                <div class="font-medium text-green-700 mb-2">{{ practice.practice }}</div>
                <div class="text-sm text-gray-600 mb-2">{{ practice.why }}</div>
                <div class="text-xs text-green-600 bg-green-50 rounded p-2">
                    <span class="font-medium">Tip:</span> {{ practice.tip }}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Step controls -->
    <div class="bg-gray-50 rounded-lg p-4">
        <div class="flex items-center justify-between mb-4">
            <h4 class="font-semibold">Learning Steps</h4>
            <div class="flex items-center space-x-2">
                <button class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                        hx-get="{{ url_for('concepts.get_step', concept_name=concept.name, step_num=current_step - 1) }}?query={{ query | urlencode }}"
                        hx-target="#visualization-area"
                        {% if current_step <= 0 %}disabled{% endif %}>Prev</button>
                <span class="px-3 py-1 bg-white rounded border">{{ current_step + 1 }} / {{ steps | length }}</span>
                <button class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300 disabled:opacity-50"
                        hx-get="{{ url_for('concepts.get_step', concept_name=concept.name, step_num=current_step + 1) }}?query={{ query | urlencode }}"
                        hx-target="#visualization-area"
                        {% if current_step >= steps | length - 1 %}disabled{% endif %}>Next</button>
            </div>
        </div>
        {% if steps %}
        <div class="bg-white rounded border p-4">
            <div class="font-medium text-amber-600">{{ steps[current_step].title }}</div>
            <p class="text-gray-600 mt-1">{{ steps[current_step].description }}</p>
        </div>
        {% endif %}
    </div>
</div>

{# Query Results and Error Display #}
{% include 'components/error_display.html' %}
{% include 'components/results_table.html' %}
